<div class="product-detail-page">
  <div class="container">
    <div class="breadcrumb">
      <a routerLink="/">Trang ch·ªß</a><span class="separator">/</span><a routerLink="/products">S·∫£n ph·∫©m</a><span class="separator">/</span><span class="current" *ngIf="product">{{ product.name }}</span>
    </div>

    @if (isLoading) {
      <div class="loading-state"><div class="loading-spinner"></div><p>ƒêang t·∫£i th√¥ng tin s·∫£n ph·∫©m...</p></div>
    } @else if (product) {
      <div class="product-detail">
        <div class="product-main">

          <div class="product-images">
            <div class="main-image">
              @if (isMediaVideo(selectedImage)) {
                <video [src]="selectedImage" class="product-video" controls autoplay muted loop playsinline></video>
              } @else {
                <img [src]="selectedImage || defaultPlaceholder" [alt]="product.name" class="product-image">
              }
              <div class="image-badges">
                @if (product.originalPrice && product.originalPrice > product.price) { <div class="discount-badge">-{{ getDiscount() }}%</div> }
                @if (product.stock <= 0) { <div class="out-of-stock-badge">H·∫øt H√†ng</div> }
              </div>
            </div>

            <div class="image-thumbnails" *ngIf="filteredGalleryImages.length > 0">
              @for (image of filteredGalleryImages; track image) {
                @if (isMediaVideo(image)) {
                  <div class="thumbnail video-thumb" [class.active]="selectedImage === image" (click)="changeImage(image)"><span class="video-icon">‚ñ∂Ô∏è</span><video [src]="image" muted preload="metadata"></video></div>
                } @else {
                  <div class="thumbnail" [class.active]="selectedImage === image" (click)="changeImage(image)"><img [src]="image" [alt]="product.name"></div>
                }
              }
            </div>
          </div>

          <div class="product-info">
            <div class="product-header">
              <h1 class="product-title">{{ product.name }}</h1>
              <div class="product-meta">
                <span class="product-brand">Th∆∞∆°ng hi·ªáu: {{ product.brand }}</span>

                @if (product.connectivity) {
                  <span class="product-connectivity" style="border-left: 1px solid #ccc; padding-left: 1rem;">
                    Lo·∫°i: <strong>{{ getConnectivityLabel(product.connectivity) }}</strong>
                  </span>
                }

                <span class="product-stock" [class.in-stock]="product.stock > 0" [class.out-of-stock]="product.stock <= 0">{{ product.stock > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng' }}</span>
              </div>
            </div>

            <div class="product-rating">
              <div class="rating-stars"><span class="stars">{{ getStarRating(product.rating || 0) }}</span><span class="rating-value">{{ (product.rating || 0) | number:'1.1-1' }}/5</span></div>
              <span class="reviews-count">({{ product.reviewCount }} ƒë√°nh gi√°)</span>
              <a (click)="setActiveTab('reviews')" class="write-review"></a>
            </div>

            <div class="product-price">
              <span class="current-price">{{ product.price | number }}‚Ç´</span>
              @if (product.originalPrice && product.originalPrice > product.price) { <span class="original-price">{{ product.originalPrice | number }}‚Ç´</span><span class="discount-amount">Ti·∫øt ki·ªám: {{ (product.originalPrice - product.price) | number }}‚Ç´</span> }
            </div>

            @if (product.colors && product.colors.length > 0) {
               <div class="product-color-variants" style="margin-bottom: 20px;">
                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label class="color-label" style="display: block; font-weight: 600; margin: 0;">M√†u s·∫Øc:</label>
                    <button (click)="showAllImages()"
                            [style.color]="selectedVariant === null ? '#667eea' : '#666'"
                            style="background: none; border: none; font-size: 0.85rem; cursor: pointer; text-decoration: underline;">
                        Xem t·∫•t c·∫£ ·∫£nh
                    </button>
                 </div>
                 <div class="variant-options" style="display: flex; gap: 10px; flex-wrap: wrap;">
                   @for (color of product.colors; track color) {
                     <button type="button" class="variant-swatch" [class.active]="selectedVariant === color" (click)="selectVariant(color)" [title]="selectedVariant === color ? 'B·ªè ch·ªçn' : 'Ch·ªçn m√†u ' + color"
                             [ngStyle]="isHex(color) ? { 'width': '40px', 'height': '40px', 'padding': '4px', 'border-radius': '50%', 'justify-content': 'center' } : { 'width': 'auto', 'height': 'auto', 'padding': '5px 10px', 'border-radius': '8px' }"
                             [style.border-color]="selectedVariant === color ? 'var(--primary-color)' : '#e2e8f0'"
                             [style.transform]="selectedVariant === color ? 'scale(1.1)' : 'scale(1)'"
                             style="border: 2px solid #e2e8f0; cursor: pointer; display: flex; align-items: center; gap: 8px; background: white; transition: all 0.2s ease;">
                       <div class="color-indicator" [style.background-color]="isHex(color) ? color : '#ccc'" [ngStyle]="isHex(color) ? { 'width': '100%', 'height': '100%' } : { 'width': '20px', 'height': '20px' }" style="border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;">@if (!isHex(color)) { <span style="font-size: 10px; color: #555;">?</span> }</div>
                       @if (!isHex(color)) { <span class="variant-name">{{ color }}</span> }
                     </button>
                   }
                 </div>
               </div>
             }

            <!-- <div class="product-short-desc"><p>{{ product.description }}</p></div> -->

            <div class="product-features" *ngIf="product.features && product.features.length > 0">
              <h3>ƒê·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t:</h3>
              <ul class="features-list">
                @for (feature of product.features; track feature) {
                  <li class="feature-item"><span class="feature-icon">‚úì</span> {{ feature }}</li>
                }
              </ul>
            </div>

            <div class="product-actions">
              <div class="quantity-selector">
                <label class="quantity-label">S·ªë l∆∞·ª£ng:</label>
                <div class="quantity-controls">
                  <button class="quantity-btn" (click)="decreaseQuantity()" [disabled]="quantity <= 1">‚àí</button>
                  <span class="quantity-display">{{ quantity }}</span>
                  <button class="quantity-btn" (click)="increaseQuantity()" [disabled]="quantity >= product.stock">+</button>
                </div>
              </div>
              <div class="action-buttons">
                <button class="btn btn-secondary add-to-cart-btn" (click)="addToCart()" [disabled]="product.stock <= 0"><span class="btn-icon">üõí</span> Th√™m V√†o Gi·ªè</button>
                <button class="btn btn-primary buy-now-btn" (click)="buyNow()" [disabled]="product.stock <= 0"><span class="btn-icon">‚ö°</span> Mua Ngay</button>
                <button class="btn btn-wishlist" (click)="addToWishlist()" [class.in-wishlist]="isInWishlist()" title="Th√™m v√†o y√™u th√≠ch"><span class="btn-icon">{{ isInWishlist() ? '‚ù§Ô∏è' : 'ü§ç' }}</span></button>
              </div>
            </div>

            <div class="product-meta-info">
               <div class="meta-item"><span class="meta-icon">üöö</span><div class="meta-text"><strong>Giao h√†ng mi·ªÖn ph√≠</strong><span>Cho ƒë∆°n h√†ng t·ª´ 500K</span></div></div>
               <div class="meta-item"><span class="meta-icon">üîí</span><div class="meta-text"><strong>B·∫£o h√†nh {{ product.warranty || '2 nƒÉm' }}</strong><span>Ch√≠nh h√£ng to√†n qu·ªëc</span></div></div>
               <div class="meta-item"><span class="meta-icon">üîÑ</span><div class="meta-text"><strong>{{ getReturnPolicyText() }}</strong><span>Ho√†n ti·ªÅn 100%</span></div></div>
               <div class="meta-item"><span class="meta-icon">üìû</span><div class="meta-text"><strong>H·ªó tr·ª£ 24/7</strong><span>{{ getSupportPhone() }}</span></div></div>
            </div>

             @if (showAdminNotice()) {
              <div class="admin-notice"><div class="admin-icon">üëë</div><div class="admin-text"><strong>Ch·∫ø ƒë·ªô Qu·∫£n tr·ªã vi√™n</strong><span>B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a th√¥ng tin s·∫£n ph·∫©m</span></div></div>
            }
          </div>
        </div>

        <div class="product-tabs">
            <div class="tab-headers">
            <button class="tab-header" [class.active]="activeTab === 'description'" (click)="setActiveTab('description')">üìñ M√¥ T·∫£</button>
            <button class="tab-header" [class.active]="activeTab === 'specs'" (click)="setActiveTab('specs')">‚öôÔ∏è Th√¥ng S·ªë</button>
            <button class="tab-header" [class.active]="activeTab === 'reviews'" (click)="setActiveTab('reviews')">‚≠ê ƒê√°nh Gi√° ({{ product.reviewCount }})</button>
            <button class="tab-header" [class.active]="activeTab === 'warranty'" (click)="setActiveTab('warranty')">üõ°Ô∏è B·∫£o H√†nh</button>
          </div>
          <div class="tab-content">
            @if (activeTab === 'description') {
              <div class="tab-pane">
                <div class="description-content">
                  <h3>Chi Ti·∫øt S·∫£n Ph·∫©m</h3><p [innerHTML]="product.description"></p>
                  <!-- <div class="product-benefits"><h4>üéØ L·ª£i √≠ch khi s·ª≠ d·ª•ng:</h4><div class="benefits-grid"><div class="benefit-item"><span class="benefit-icon">üéµ</span><div class="benefit-text"><strong>√Çm thanh s·ªëng ƒë·ªông</strong><p>Ch·∫•t l∆∞·ª£ng √¢m thanh cao c·∫•p</p></div></div><div class="benefit-item"><span class="benefit-icon">üîã</span><div class="benefit-text"><strong>Pin l√¢u d√†i</strong><p>S·ª≠ d·ª•ng c·∫£ ng√†y d√†i</p></div></div></div></div> -->
                </div>
              </div>
            }
            @if (activeTab === 'specs') {
               <div class="tab-pane">
                <h3>üìä Th√¥ng S·ªë K·ªπ Thu·∫≠t</h3>
                <div class="specs-table">
                  @if (product.brand) { <div class="spec-row"><span class="spec-label">Th∆∞∆°ng hi·ªáu</span><span class="spec-value">{{ product.brand }}</span></div> }
                  @if (product.type) { <div class="spec-row"><span class="spec-label">Lo·∫°i</span><span class="spec-value">{{ product.type }}</span></div> }

                  @if (product.connectivity) { <div class="spec-row"><span class="spec-label">K·∫øt n·ªëi</span><span class="spec-value">{{ getConnectivityLabel(product.connectivity) }}</span></div> }

                  @if (product.weight) { <div class="spec-row"><span class="spec-label">Tr·ªçng l∆∞·ª£ng</span><span class="spec-value">{{ product.weight }}</span></div> }
                  @if (product.batteryLife) { <div class="spec-row"><span class="spec-label">Pin</span><span class="spec-value">{{ product.batteryLife }}</span></div> }
                </div>
              </div>
            }
            @if (activeTab === 'reviews') {
                <div class="tab-pane">
                    <div class="reviews-content">
                    @if (!authService.isLoggedIn) {
                        <div class="review-login-prompt"><h3>G·ª≠i ƒë√°nh gi√° c·ªßa b·∫°n</h3><p>Vui l√≤ng <a routerLink="/login">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ g·ª≠i ƒë√°nh gi√°!</p></div>
                    } @else {
                        <div class="review-form-container">
                        <h3>G·ª≠i ƒë√°nh gi√°</h3>
                        <form #reviewForm="ngForm" (ngSubmit)="onSubmitReview(reviewForm)" class="review-form">
                            <div class="form-group">
                                <label class="form-label">ƒê√°nh gi√°:</label>
                                <div class="star-rating-input">
                                    <input type="radio" id="star5" [(ngModel)]="newReview.rating" name="rating" [value]="5" required><label for="star5">‚òÖ</label>
                                    <input type="radio" id="star4" [(ngModel)]="newReview.rating" name="rating" [value]="4" required><label for="star4">‚òÖ</label>
                                    <input type="radio" id="star3" [(ngModel)]="newReview.rating" name="rating" [value]="3" required><label for="star3">‚òÖ</label>
                                    <input type="radio" id="star2" [(ngModel)]="newReview.rating" name="rating" [value]="2" required><label for="star2">‚òÖ</label>
                                    <input type="radio" id="star1" [(ngModel)]="newReview.rating" name="rating" [value]="1" required><label for="star1">‚òÖ</label>
                                </div>
                            </div>
                            <div class="form-group"><textarea [(ngModel)]="newReview.comment" name="comment" class="form-input" rows="3" placeholder="Nh·∫≠p b√¨nh lu·∫≠n..." required></textarea></div>
                            <button type="submit" class="btn btn-primary" [disabled]="reviewForm.invalid || isSubmittingReview">{{ isSubmittingReview ? 'ƒêang g·ª≠i...' : 'G·ª≠i' }}</button>
                        </form>
                        </div>
                    }
                    <div class="reviews-list-container">
                        <h3>T·∫•t c·∫£ ƒë√°nh gi√° ({{ product.reviewCount }})</h3>
                        @if (!product.reviews || product.reviews.length === 0) { <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p> } @else {
                            <div class="reviews-list">
                                @for (review of product.reviews; track $index) {
                                    <div class="review-item">
                                        <div class="review-header"><span class="reviewer-name">{{ review.author }}</span><div class="review-rating">{{ '‚òÖ'.repeat(review.rating) }}</div></div>
                                        <p>{{ review.comment }}</p><span class="review-date">{{ review.createdAt | date:'dd/MM/yyyy' }}</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                    </div>
                </div>
            }
            @if (activeTab === 'warranty') {
              <div class="tab-pane">
                 <h3>üõ°Ô∏è Ch√≠nh S√°ch B·∫£o H√†nh</h3>
                 <p>S·∫£n ph·∫©m ƒë∆∞·ª£c b·∫£o h√†nh ch√≠nh h√£ng {{ product.warranty || '12 th√°ng' }}.</p>
                 <p>ƒê·ªïi tr·∫£ trong v√≤ng {{ product.returnPolicyDays || 30 }} ng√†y n·∫øu c√≥ l·ªói nh√† s·∫£n xu·∫•t.</p>
              </div>
            }
          </div>
        </div>

        @if (relatedProducts.length > 0) {
          <div class="related-products">
            <h2 class="section-title">S·∫£n Ph·∫©m Li√™n Quan</h2>
            <div class="related-products-grid">
              @for (relatedProduct of relatedProducts; track relatedProduct.id) {
                <app-product-card [product]="relatedProduct"></app-product-card>
              }
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="not-found"><h2>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</h2><button class="btn btn-primary" routerLink="/products">Quay l·∫°i c·ª≠a h√†ng</button></div>
    }
  </div>
</div>
