<div class="cart-page">
  <div class="container">
    
    @if (isLoading) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>ƒêang t·∫£i gi·ªè h√†ng...</p>
      </div>
    } @else {
      @if (cartItems.length > 0) {
        <div class="page-header">
          <h1>üõí Gi·ªè H√†ng C·ªßa B·∫°n</h1>
          <p>B·∫°n ƒëang c√≥ <strong>{{ cartItems.length }}</strong> s·∫£n ph·∫©m trong gi·ªè h√†ng</p>
        </div>

        <div class="cart-layout">
          <div class="cart-items-section">
            
            <div class="cart-items-header">
              <span>S·∫£n ph·∫©m</span>
              <span class="header-quantity">S·ªë l∆∞·ª£ng</span>
              <span class="header-total">T·ªïng c·ªông</span>
            </div>

            <div class="cart-items-list">
              @for (item of cartItems; track item.productId) {
                <div class="cart-item">
                  <div class="item-product">
                    <img [src]="getFullImageUrl(item.image)" [alt]="item.productName" class="item-image" />
                    <div class="item-details">
                      <h3 class="item-name">{{ item.productName }}</h3>
                      <p class="item-sku">M√£ SP: {{ item.productId }}</p>
                      <p class="item-price">{{ item.price | number }}‚Ç´</p>
                    </div>
                  </div>
                  
                  <div class="item-quantity">
                    <div class="quantity-controls">
                      <button class="qty-btn" (click)="updateQuantity(item, item.quantity - 1)" 
                              [disabled]="item.quantity <= 1">
                        ‚àí
                      </button>
                      <span class="quantity">{{ item.quantity }}</span>
                      <button class="qty-btn" (click)="updateQuantity(item, item.quantity + 1)">
                        +
                      </button>
                    </div>
                  </div>

                  <div class="item-total">
                    <span class="total-amount">{{ getItemTotal(item) | number }}‚Ç´</span>
                  </div>

                  <button class="remove-btn" (click)="removeItem(item.productId)" title="X√≥a s·∫£n ph·∫©m">
                    √ó
                  </button>
                </div>
              }
            </div>

            <div class="cart-actions-footer">
              <button class="btn-clear" (click)="clearCart()">
                üóëÔ∏è X√≥a t·∫•t c·∫£ gi·ªè h√†ng
              </button>
              <button class="btn-continue" (click)="continueShopping()">
                ‚Üê Ti·∫øp t·ª•c mua s·∫Øm
              </button>
            </div>
          </div>

          <div class="order-summary-section">
            <div class="summary-card">
              <h3>T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
              
              <div class="summary-row">
                <span>T·∫°m t√≠nh ({{ cartItems.length }} s·∫£n ph·∫©m)</span>
                <strong>{{ total | number }}‚Ç´</strong>
              </div>

              <div class="summary-row">
                <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                <span class="free-shipping">Mi·ªÖn ph√≠</span>
              </div>

              @if (discount > 0) {
                <div class="summary-row discount">
                  <span>Gi·∫£m gi√° ({{ appliedPromoCode }}):</span>
                  <strong>-{{ discount | number }}‚Ç´</strong>
                </div>
              }
              
              <div class="divider"></div>
              
              <div class="summary-row total">
                <strong>T·ªïng thanh to√°n:</strong>
                <strong class="total-amount">{{ getGrandTotal() | number }}‚Ç´</strong>
              </div>

              <div class="promotion-section">
                <label for="promo-code">M√£ gi·∫£m gi√°</label>
                <div class="promo-input">
                  <input type="text" id="promo-code" placeholder="Nh·∫≠p m√£ c·ªßa b·∫°n..." [(ngModel)]="promoCode" />
                  <button class="btn-apply" (click)="applyPromoCode()">√Åp d·ª•ng</button>
                </div>
                @if (promoMessage) {
                  <div class="promo-message" [class.success]="promoMessage.type === 'success'" [class.error]="promoMessage.type === 'error'">
                    {{ promoMessage.text }}
                  </div>
                }
              </div>
              <button class="btn-checkout" (click)="proceedToCheckout()">
                üéâ Ti·∫øn h√†nh thanh to√°n
              </button>
            </div>
          </div>
        </div>
      } @else {
        <div class="empty-cart">
          <div class="empty-icon">üì¶</div>
          <h2>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h2>
          <p>H√£y kh√°m ph√° v√† th√™m nh·ªØng s·∫£n ph·∫©m y√™u th√≠ch v√†o gi·ªè h√†ng!</p>
          <div class="empty-actions">
            <button class="btn-primary" (click)="continueShopping()">
              üéµ Kh√°m ph√° s·∫£n ph·∫©m
            </button>
             <button class="btn-secondary" routerLink="/products">
               üîç Xem t·∫•t c·∫£ s·∫£n ph·∫©m
             </button>
          </div>
        </div>
      }

      @if (productsToShow && productsToShow.length > 0) {
        <div class="recently-viewed">
          <h3 class="section-title">C√≥ th·ªÉ b·∫°n s·∫Ω th√≠ch</h3>
          <div class="recent-products">
            @for (product of productsToShow; track product.id) {
              <a [routerLink]="['/products', product.id]" class="recent-product">
                <div class="product-image">
                  <img [src]="getFullImageUrl(product.imageUrl)" [alt]="product.name">
                </div>
                <div class="product-info">
                  <h4>{{ product.name }}</h4>
                  <div class="product-price">
                    <span class="current-price">{{ product.price | number }}‚Ç´</span>
                  </div>
                </div>
              </a>
            }
          </div>
        </div>
      }

    }

  </div>
</div>