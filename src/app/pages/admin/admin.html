<div class="admin-page">
  <div class="container">

    <div class="admin-header">
      <h1 class="page-title">Qu·∫£n L√Ω Atheng Audio</h1>
      <div class="admin-actions">
        @if (activeTab === 'products') {
          <button class="btn btn-secondary" (click)="addProduct()">
            + Th√™m S·∫£n Ph·∫©m
          </button>
        }
        <button class="btn btn-secondary" routerLink="/">
          ‚Üê V·ªÅ Trang Ch·ªß
        </button>
      </div>
    </div>

    <div class="admin-stats">
      <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-info">
          <div class="stat-number">{{ stats.totalProducts | number }}</div>
          <div class="stat-label">S·∫£n Ph·∫©m</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üõí</div>
        <div class="stat-info">
          <div class="stat-number">{{ stats.totalOrders | number }}</div>
          <div class="stat-label">ƒê∆°n H√†ng</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-info">
          <div class="stat-number">{{ stats.totalRevenue | number }}‚Ç´</div>
          <div class="stat-label">Doanh Thu</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí¨</div>
        <div class="stat-info">
          <div class="stat-number">{{ conversations.length }}</div>
          <div class="stat-label">H·ªôi Tho·∫°i</div>
        </div>
      </div>
    </div>

    <div class="admin-tabs">
      <div class="tab-headers">
        <button class="tab-header" [class.active]="activeTab === 'products'" (click)="setActiveTab('products')">
          üì¶ S·∫£n Ph·∫©m
        </button>
        <button class="tab-header" [class.active]="activeTab === 'orders'" (click)="setActiveTab('orders')">
          üõí ƒê∆°n H√†ng
        </button>
        <button class="tab-header" [class.active]="activeTab === 'chat'" (click)="setActiveTab('chat')">
          üí¨ H·ªó Tr·ª£ Kh√°ch H√†ng
        </button>
      </div>

      <div class="tab-content">

        @if (activeTab === 'products') {
          <div class="tab-pane">
             <div class="products-table">
                <div class="table-header"><h3>Danh S√°ch S·∫£n Ph·∫©m</h3></div>
                <div class="table-content">
                    <div class="table-row header-row">
                        <div class="col col-image">·∫¢nh</div>
                        <div class="col col-name">T√™n</div>
                        <div class="col col-price">Gi√°</div>
                        <div class="col col-stock">Kho</div>
                        <div class="col col-actions">Thao t√°c</div>
                    </div>
                    @for (product of products; track product.id) {
                        <div class="table-row">
                            <div class="col col-image">
                                <img [src]="product.image" class="product-thumb" onerror="this.src='assets/images/default-product.png'">
                            </div>
                            <div class="col col-name">{{ product.name }}</div>
                            <div class="col col-price">{{ product.price | number }}‚Ç´</div>
                            <div class="col col-stock">{{ product.stock }}</div>
                            <div class="col col-actions">
                                <button class="btn-edit" (click)="editProduct(product)">S·ª≠a</button>
                                <button class="btn-delete" (click)="deleteProduct(product.id)">X√≥a</button>
                            </div>
                        </div>
                    }
                </div>
             </div>
          </div>
        }

        @if (activeTab === 'orders') {
          <div class="tab-pane">
             <div class="orders-table">
                <div class="table-header"><h3>Danh S√°ch ƒê∆°n H√†ng</h3></div>
                <div class="table-content">
                    <div class="table-row header-row">
                        <div class="col">M√£</div>
                        <div class="col">Kh√°ch</div>
                        <div class="col">T·ªïng</div>
                        <div class="col">Tr·∫°ng th√°i</div>
                        <div class="col">Thao t√°c</div>
                    </div>
                    @for (order of orders; track order.id) {
                        <div class="table-row">
                            <div class="col">#{{ order.id?.slice(-6) }}</div>
                            <div class="col">{{ order.shippingAddress.fullName }}</div>
                            <div class="col">{{ order.totalAmount | number }}‚Ç´</div>
                            <div class="col">
                                <select [value]="order.status" (change)="updateOrderStatus(order.id, $event)" [style.background]="getStatusColor(order.status)" class="status-select">
                                    <option value="PENDING">Ch·ªù x·ª≠ l√Ω</option>
                                    <option value="CONFIRMED">ƒê√£ x√°c nh·∫≠n</option>
                                    <option value="SHIPPED">ƒêang giao</option>
                                    <option value="DELIVERED">ƒê√£ giao</option>
                                    <option value="CANCELLED">H·ªßy</option>
                                </select>
                            </div>
                            <div class="col">
                                <button class="btn-view" (click)="viewOrder(order.id)">Xem</button>
                            </div>
                        </div>
                    }
                </div>
             </div>
          </div>
        }

        @if (activeTab === 'chat') {
          <div class="tab-pane chat-pane">
            <div class="chat-layout">

              <div class="chat-sidebar">
                <div class="sidebar-header">
                  <h3>H·ªôi tho·∫°i</h3>
                </div>
                <div class="conversation-list">
                  @for (user of conversations; track user.id) {
                    <div class="conversation-item"
                         [class.active]="selectedChatUser?.id === user.id"
                         (click)="selectUserToChat(user)">

                      <div class="user-avatar-container">
                        <div class="user-avatar">
                          {{ user.name ? user.name.charAt(0).toUpperCase() : 'U' }}
                        </div>
                        @if (user.unreadCount && user.unreadCount > 0) {
                          <span class="unread-badge">{{ user.unreadCount }}</span>
                        }
                      </div>

                      <div class="user-info">
                        <div class="user-name">{{ user.name }}</div>
                        <div class="user-email" [style.color]="user.unreadCount ? '#333' : '#666'" [style.font-weight]="user.unreadCount ? 'bold' : 'normal'">
                             {{ user.email }}
                        </div>
                      </div>
                    </div>
                  }
                  @if (conversations.length === 0) {
                    <div class="empty-conv">
                      <p>Ch∆∞a c√≥ tin nh·∫Øn n√†o.</p>
                    </div>
                  }
                </div>
              </div>

              <div class="chat-main">
                @if (selectedChatUser) {
                  <div class="chat-header">
                    <div class="user-avatar-small">
                      {{ selectedChatUser.name ? selectedChatUser.name.charAt(0).toUpperCase() : 'U' }}
                    </div>
                    <div class="header-info">
                      <h4>{{ selectedChatUser.name }}</h4>
                      <span>Kh√°ch h√†ng</span>
                    </div>
                  </div>

                  <div class="chat-messages" #chatContainer>
                    @if (chatMessages.length === 0) {
                        <div class="no-messages">
                            <p>Ch∆∞a c√≥ l·ªãch s·ª≠ tr√≤ chuy·ªán.</p>
                            <p>H√£y g·ª≠i tin nh·∫Øn ƒë·∫ßu ti√™n!</p>
                        </div>
                    }

                    @for (msg of chatMessages; track msg.id) {
                      <div class="message"
                           [class.sent]="msg.from === authService.currentUserValue?.id"
                           [class.received]="msg.from !== authService.currentUserValue?.id">

                        <div class="msg-bubble">
                          {{ msg.content }}
                        </div>
                        <div class="msg-time">
                          {{ msg.timestamp | date:'HH:mm dd/MM' }}
                        </div>
                      </div>
                    }
                  </div>

                  <div class="chat-input-area">
                    <input type="text"
                           [(ngModel)]="adminMessage"
                           (keyup.enter)="sendAdminMessage()"
                           placeholder="Nh·∫≠p tin nh·∫Øn tr·∫£ l·ªùi..."
                           class="chat-input">
                    <button class="btn-send" (click)="sendAdminMessage()">
                      ‚û§
                    </button>
                  </div>

                } @else {
                  <div class="empty-chat-state">
                    <div class="empty-icon">üí¨</div>
                    <h3>Ch·ªçn m·ªôt kh√°ch h√†ng ƒë·ªÉ h·ªó tr·ª£</h3>
                  </div>
                }
              </div>

            </div>
          </div>
        }
      </div>
    </div>

    @if (showProductForm) {
        <div class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>{{ editingProduct ? 'S·ª≠a' : 'Th√™m' }} S·∫£n Ph·∫©m</h2>
                    <button class="modal-close" (click)="cancelEdit()">√ó</button>
                </div>
                <div class="modal-body">
                    <form (ngSubmit)="saveProduct()" class="product-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">T√™n S·∫£n Ph·∫©m</label>
                                <input type="text" [(ngModel)]="productForm.name" name="name" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gi√° (VNƒê)</label>
                                <input type="number" [(ngModel)]="productForm.price" name="price" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gi√° G·ªëc (VNƒê)</label>
                                <input type="number" [(ngModel)]="productForm.originalPrice" name="originalPrice" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Danh M·ª•c</label>
                                <select [(ngModel)]="productForm.category" name="category" class="form-input">
                                    <option value="headphone">Tai Nghe</option>
                                    <option value="speaker">Loa</option>
                                    <option value="accessory">Ph·ª• ki·ªán</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Th∆∞∆°ng Hi·ªáu</label>
                                <input type="text" [(ngModel)]="productForm.brand" name="brand" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">T·ªìn kho</label>
                                <input type="number" [(ngModel)]="productForm.stock" name="stock" class="form-input">
                            </div>

                            <div class="form-group full-width">
                                <label class="form-label">Video S·∫£n Ph·∫©m</label>
                                <input type="file" (change)="onVideoSelected($event)" class="form-input" [disabled]="isUploading" accept="video/mp4,video/webm">
                                @if (productForm.videoUrl) {
                                    <div class="image-preview" style="margin-top: 10px;">
                                        <video [src]="productForm.videoUrl" controls width="200"></video>
                                    </div>
                                }
                            </div>

                             <div class="form-group full-width">
                                <label class="form-label">M√†u S·∫Øc & ·∫¢nh</label>
                                <div class="variant-groups-container" style="display: flex; flex-direction: column; gap: 20px;">
                                    @for (group of colorVariantGroups; track $index; let groupIndex = $index) {
                                        <div class="variant-group" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #f8fafc;">
                                            <div class="color-input-wrapper" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                                <input type="color" [(ngModel)]="group.colorName" name="colorPicker_{{groupIndex}}" style="width: 40px; height: 40px; cursor: pointer; border: none; background: none;">
                                                <input type="text" [(ngModel)]="group.colorName" name="groupColorName_{{groupIndex}}" class="form-input" placeholder="T√™n/M√£ m√†u" style="flex: 1;" required>
                                                <button type="button" class="btn-danger" style="padding: 5px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;" (click)="removeColorGroup(groupIndex)">X√≥a nh√≥m</button>
                                            </div>

                                            <div class="image-list-group">
                                                @for (url of group.imageUrls; track $index; let imgIndex = $index) {
                                                    <div class="image-input-item" style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                        <input type="file" (change)="onFileSelected($event, groupIndex, imgIndex)" class="form-input" [disabled]="isUploading" accept="image/*" style="flex: 1;">
                                                        @if (url && url.trim() !== '') {
                                                            <div class="image-preview-small" style="width: 50px; height: 50px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                                                                <img [src]="url" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;">
                                                            </div>
                                                        }
                                                        <button type="button" (click)="removeImageFromGroup(group, imgIndex)" style="background: #e2e8f0; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">-</button>
                                                    </div>
                                                }
                                                <button type="button" (click)="addImageToGroup(group)" style="background: none; border: 1px dashed #667eea; color: #667eea; padding: 5px 15px; border-radius: 4px; cursor: pointer; width: 100%;">+ Th√™m ·∫£nh</button>
                                            </div>
                                        </div>
                                    }
                                    <button type="button" (click)="addColorGroup()" style="background: #e0e7ff; color: #4f46e5; border: 1px dashed #4f46e5; padding: 10px;">+ Th√™m Nh√≥m M√†u M·ªõi</button>
                                </div>
                            </div>

                            <div class="form-group full-width">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea [(ngModel)]="productForm.description" name="description" class="form-input" rows="3"></textarea>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" (click)="cancelEdit()">H·ªßy</button>
                            <button type="submit" class="btn btn-primary" [disabled]="isUploading">
                                {{ isUploading ? 'ƒêang t·∫£i...' : 'L∆∞u' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }

  </div>
</div>
