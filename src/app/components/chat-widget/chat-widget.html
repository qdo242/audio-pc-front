<div class="chat-widget-container">
  @if (isOpen) {
    <div class="chat-window">
      <div class="chat-header">
        <div class="header-info">
          <h3>{{ chatMode === 'BOT' ? 'Atheng AI ğŸ¤–' : 'Há»— Trá»£ ViÃªn ğŸ‘¨â€ğŸ’»' }}</h3>
          
          @if (authService.isLoggedIn && !isUserAdmin) {
            <div class="mode-switch">
              <button 
                class="switch-btn" 
                [class.active]="chatMode === 'BOT'"
                (click)="switchMode('BOT')"
                title="Chat vá»›i AI">
                ğŸ¤–
              </button>
              <button 
                class="switch-btn" 
                [class.active]="chatMode === 'ADMIN'"
                (click)="switchMode('ADMIN')"
                title="Chat vá»›i NhÃ¢n viÃªn">
                ğŸ‘¨â€ğŸ’»
              </button>
            </div>
          }
        </div>
        <button class="close-btn" (click)="toggleChat()">Ã—</button>
      </div>
      
      <div class="chat-body">
        @if (authService.isLoggedIn) {
          <div class="messages-list">
            <div class="welcome-message">
              <p>
                @if (chatMode === 'BOT') {
                  ChÃ o báº¡n! MÃ¬nh lÃ  AI cá»§a Atheng Audio. Báº¡n cáº§n tÃ¬m tai nghe hay loa gÃ¬ nhá»‰?
                } @else {
                  ÄÃ¢y lÃ  kÃªnh chat trá»±c tiáº¿p vá»›i nhÃ¢n viÃªn. Vui lÃ²ng chá» pháº£n há»“i.
                }
              </p>
            </div>

            @for (msg of displayMessages$ | async; track msg.id) {
              <div class="message" 
                   [class.sent]="msg.from === authService.currentUserValue?.id" 
                   [class.received]="msg.from !== authService.currentUserValue?.id">
                
                @if (msg.from !== authService.currentUserValue?.id) {
                  <span class="msg-sender">{{ msg.fromName }}</span>
                }
                
                <span class="msg-content" [innerHTML]="msg.content"></span>
              </div>
            }

            @if (isBotTyping && chatMode === 'BOT') {
              <div class="message received">
                <span class="msg-sender">Trá»£ lÃ½ AI</span>
                <span class="msg-content typing">
                  <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                </span>
              </div>
            }
          </div>
        } @else {
          <div class="chat-login-prompt">
            <p>ğŸ‘‹ Xin chÃ o!</p>
            <p>Vui lÃ²ng <a routerLink="/login" (click)="toggleChat()">Ä‘Äƒng nháº­p</a> Ä‘á»ƒ báº¯t Ä‘áº§u chat.</p>
          </div>
        }
      </div>

      <div class="chat-footer">
        <input 
          type="text" 
          [placeholder]="chatMode === 'BOT' ? 'Há»i AI...' : 'Nháº¯n cho Admin...'"
          [(ngModel)]="newMessage"
          (keyup.enter)="onSendMessage()"
          [disabled]="!authService.isLoggedIn"
        />
        <button class="send-btn" (click)="onSendMessage()" [disabled]="!authService.isLoggedIn">â¤</button>
      </div>
    </div>
  }

  <button class="chat-toggle-btn" (click)="toggleChat()">
    {{ isOpen ? 'âœ•' : 'ğŸ’¬' }}
  </button>
</div>